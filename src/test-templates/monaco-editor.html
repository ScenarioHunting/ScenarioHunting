<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Template Editor</title>
    <script type="text/javascript" src="https://miro.com/app/static/sdk.1.1.js"></script>
    <link rel="stylesheet" type="text/css" href="https://miro.com/app/static/styles.1.0.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"></script>
    <link rel="stylesheet" data-name="vs/editor/editor.main"
        href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs/editor/editor.main.min.css">
    <style type="text/css" media="screen">
        /* #monaco-editor {
            position: absolute;
            top: 45px;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgb(31, 29, 32);
        } */
        #monaco-editor {
            position: absolute;
            top: 55px;
            bottom: 0;
            left: 0;
            right: 0;
            /* background-color: rgb(31, 29, 32); */
            /* width: 705px; */
        }

        .side-panel {
            display: flex;
            margin-left: 36px;
            margin-top: 9px;
            justify-content: space-between;
            margin-right: 36px;
            /* margin: 15px;
            right: 0px;
            position: absolute;
            top: 0px;
            bottom: 0px;
            background-color: white; */
        }

        .file-extension-input {
            width: 57px;
        }

        .input-field {
            padding-top: 15px;
        }

        /* .save-button {
            width: 205px;
        } */

        /* body {
            background-color: rgb(31, 29, 32);
        }

        input {
            background-color: rgb(31, 29, 32);
            color: white;
        } */
    </style>

</head>

<body>
    <div id="monaco-editor"></div>

    <div class="side-panel">

        <!-- <label for="fileNameTemplate">File name template:</label> -->
        <div class="miro-input-group miro-input-group--small">
            <input class="miro-input miro-input--primary" id="fileNameTemplate" placeholder="{{scenario}}"></input>
            <input class="file-extension-input miro-input miro-input--primary" id="fileExtension"
                placeholder="cs"></input>
        </div>


        <!-- <label for="templateName">Template Name:</label> -->
        <div class="miro-input-group miro-input-group--small">
            <input class="miro-input miro-input--primary" id="templateName" placeholder="payment-unit-test"></input>
            <button class="save-button miro-btn miro-btn--primary miro-btn--small" onclick="save()">Save</button>
        </div>

    </div>

    <!-- <div id="example-editor" style="background-color: chartreuse;"></div> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs/loader.min.js"></script>
    <script>
        function showNotification(message) {
            return miro.showNotification(message)
        }
        function close() {
            miro.board.ui.closeModal()
        }

        let templateContent = ""
        let editor
        const originalTemplateName = getParameterByName("templateName")
        document.getElementById("templateName").value = originalTemplateName
        async function save() {
            var repository = await templateRepository.getTemplateRepository()
            // var template = await repository.getTemplateByName(templateName)
            const template = {
                templateName: document.getElementById("templateName").value,
                contentTemplate: editor.getValue(),
                fileNameTemplate: document.getElementById('fileNameTemplate').value,
                fileExtension: document.getElementById('fileExtension').value,
            }
            await repository.createOrReplaceTemplate(originalTemplateName, template)
            await showNotification(`${template.templateName} saved.`)
            close()
        }

        // var repository=require("templateRepository").getTemplateRepository()
        function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        // console.log("cccccccccccccccccccccccccccccc:", templateRepository)
        // console.log("template obj:", getTemplateRepository().getTemplateByName("templateName"))
        // alert("templateName :" + getParameterByName("templateName"))
        // alert("templateContent :" + getParameterByName("templateContent"))
        // console.log("templateContent :", getParameterByName("templateContent"))
        // console.log("templateContentObj :", getParameterByName("templateContentObj"))

        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs' } });
        window.MonacoEnvironment = { getWorkerUrl: () => proxy };
        let proxy = URL.createObjectURL(new Blob([`
    self.MonacoEnvironment = {
        baseUrl: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min'
    };
    importScripts('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs/base/worker/workerMain.min.js');
`], { type: 'text/javascript' }));


        require(["vs/editor/editor.main"], async function () {
            // monaco.languages.registerDocumentFormattingEditProvider('csharp', {
            //     provideDocumentFormattingEdits: function (model, options, token) {
            //         return [
            //             {
            //                 range: {
            //                     startLineNumber: 1,
            //                     startColumn: 1,
            //                     endLineNumber: 1,
            //                     endColumn: 1
            //                 },
            //                 text: 'a'
            //             }
            //         ];
            //     }
            // });
            // monaco.languages.typescript.javascriptDefaults.setCompilerOptions({
            //     allowNonTsExtensions: true
            // });
            // monaco.languages.typescript.javascriptDefaults.setCompilerOptions(
            //     {
            //         noLib: true,
            //         allowNonTsExtensions: true
            //     });
            // monaco.languages.typescript.javascriptDefaults.setEagerModelSync(true)
            // monaco.languages.registerCompletionItemProvider('CustomExpressionLanguage', {
            //     provideCompletionItems: () => {
            //         if (!items || items.length <= 0)
            //             return { suggestions: [] };

            //         window.varSuggestions = items.map(function (x) {
            //             const one = {
            //                 label: x.Value,
            //                 kind: monaco.languages.CompletionItemKind.Keyword,
            //                 insertText: `Col("${x.Key}")`,
            //                 insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
            //             };
            //             return one;
            //         });

            //         window.pythonSuggestions = window.pythonMathMethods.map((x) => {
            //             var item = {
            //                 label: x.label,
            //                 kind: monaco.languages.CompletionItemKind.Funcion,
            //                 insertText: `${x.label}${x.arguments}`,
            //                 documentation: x.documentation,
            //                 insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
            //             };
            //             return item;
            //         });

            //         window.suggestions = window.varSuggestions.concat(window.pythonSuggestions);
            //         return { suggestions: window.suggestions };
            //     }
            // });

            // const defModel = monaco.editor.createModel(
            //     "var helloWorld = \"Hello World!\";",
            //     "csharp"
            // )

            // const textModel = monaco.editor.createModel(
            //     "helloWorld()",
            //     "csharp"
            // )

            // var templateName = getParameterByName("templateName")
            if (originalTemplateName) {
                var repository = await templateRepository.getTemplateRepository()
                var template = await repository.getTemplateByName(originalTemplateName)
                document.getElementById('fileNameTemplate').value = template.fileNameTemplate
                document.getElementById('fileExtension').value = template.fileExtension
                templateContent = template.contentTemplate
                // console.log("template content:",templateContent)
            }
            editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                value: templateContent,
                // language: 'csharp',
                // theme: 'vs-dark',
                // theme: 'monokai',
                lineHeight: 20,
                fontSize: 14,
                // wordWrap: "bounded",
                automaticLayout: true,
                wrappingIndent: 'indent',
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                formatOnType: true//!important
            });
            const fileTypes = {
                css: 'css',
                js: 'javascript',
                json: 'json',
                md: 'markdown',
                mjs: 'javascript',
                ts: 'typescript',
            }
            const model = monaco.editor.createModel(
                templateContent,
                'csharp')

            editor.setModel(model)

            // editor.trigger(‘anyString’, 'editor.action.formatDocument'); 
            // console.log(monaco.editor.getModels())
            // editor.setModel(textModel)
        });
        // console.log("cccccccccccccccccccccccccccccc:", templateRepository)
        // console.log("template obj:", getTemplateRepository().getTemplateByName("templateName"))
        // console.log("template obj:", getTemplateRepository())

    </script>

</body>

</html>
<!-- Render glyphs in the margin:
https://microsoft.github.io/monaco-editor/playground.html#interacting-with-the-editor-rendering-glyphs-in-the-margin -->
<!-- Custom Intellisense:
https://mono.software/2017/04/11/custom-intellisense-with-monaco-editor/ -->
<!-- Detect Language:
https://stackoverflow.com/questions/56681345/how-to-dynamically-set-language-according-to-file-extension-in-monaco-editor -->
<!-- Json schema editor:
https://jsoneditoronline.org/#right=local.juyaqi&left=local.toheka -->

<!-- Json Intellisense
https://www.npmjs.com/package/monaco-json -->

<!-- File saver:
https://github.com/eligrey/FileSaver.js -->

<!-- go multi-language template engine
https://github.com/kataras/go-template -->

<!-- handlebars for go
https://github.com/aymerick/raymond#quick-start -->